name: Build, Push and Update Manifests (Main Only)

on:
  push:
    branches:
      - main

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      service_changes: ${{ steps.filter.outputs.changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed services
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            weatherapi:
              - 'app/weatherapi/**'
            cctvapi:
              - 'app/cctvapi/**'

  # 변경된 서비스만 빌드, 푸시, Kustomize 업데이트
  build-push-update:
    needs: changes
    # 변경된 서비스가 있을 때만 이 Job을 실행
    if: ${{ needs.changes.outputs.service_changes != '[]' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # 'changes' Job의 결과(JSON 배열)를 'service' 변수로 주입
        service: ${{ fromJson(needs.changes.outputs.service_changes) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Kustomize 파일을 수정 후 다시 push해야 하므로 PAT 토큰 사용
          token: ${{ secrets.WOOSUNG142 }}

    # ARM 아키텍처(라즈베리 파이) 빌드를 위한 QEMU 에뮬레이터 설정   
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3  

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.WOOSUNG142 }} # Docker 로그인에도 동일한 PAT 사용

      - name: Get short SHA
        run: echo "SHORT_SHA=$(echo '${{ github.sha }}' | cut -c1-7)" >> $GITHUB_ENV

      - name: Build and Push image to GHCR
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ./app/${{ matrix.service }}
          # Dockerfile 경로를 'matrix.service'로 동적 지정
          file: ./app/${{ matrix.service }}/Dockerfile
          push: true
          platforms: linux/amd64, linux/arm64   # PC용(amd64)과 라즈베리 파이용(arm64) 멀티-플랫폼 빌드
          tags: |
            ghcr.io/${{ github.repository_owner }}/weather-k3s/${{ matrix.service }}:${{ github.ref_name }}
            ghcr.io/${{ github.repository_owner }}/weather-k3s/${{ matrix.service }}:${{ github.ref_name }}-${{ env.SHORT_SHA }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Update Kustomize Manifest
        if: github.ref_name == 'main'
        run: |
          export IMAGE_TAG="${{ github.ref_name }}-${{ env.SHORT_SHA }}"

          export KUSTOMIZE_PATH="k3s/overlays/prod/kustomization.yaml"

          echo "Updating ${KUSTOMIZE_PATH} for ${{ matrix.service }} with tag ${IMAGE_TAG}"

          # Git 봇 설정
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod a+x /usr/local/bin/yq

          yq e '(.images[] | select(.name | test("ghcr.io/${{ github.repository_owner }}/weather-k3s/${{ matrix.service }}")) | .newTag) = strenv(IMAGE_TAG)' -i ${KUSTOMIZE_PATH}

          # (무한 루프 방지)
          git add ${KUSTOMIZE_PATH}
          git commit -m "ci: Update ${{ matrix.service }} image to tag ${IMAGE_TAG} [skip ci]" || echo "No changes to commit"
          git push